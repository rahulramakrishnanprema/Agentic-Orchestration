# Deployment Document for FUELEU-1234

## Metadata
- **Issue Key:** FUELEU-1234  
- **Summary:** FuelEU Maritime Regulation  
- **Created At:** 2025-10-14T12:00:00Z  
- **Version:** 1.0  

## Project Overview
- **Description:** A backend API and monitoring platform to support the 2025 FuelEU Maritime Regulation, providing baseline GHG data collection, credit calculation for on‑board renewable energy, shore power integration specifications, and a compliance monitoring system with QA testing.  
- **Project Type:** API + monitoring platform  
- **Architecture:** MVC with FastAPI backend, SQLAlchemy ORM, and modular service layers  

## Implementation Plan
### Subtasks
- Subtask 1: Collect 2020 baseline life‑cycle GHG emissions (CO₂, CH₄, N₂O) for all EU MRV‑covered ship types and define the mandatory improvement schedule (2 % reduction in 2025, linear ramp to 75 % by 2050) with interim milestones.  
- Subtask 2: Design and implement a credit framework that rewards on‑board renewable energy generation (e.g., wind power) and integrates those credits into the ship’s overall GHG intensity calculation.  
- Subtask 3: Develop technical specifications and an integration plan for shore power connectivity on container and passenger vessels, covering vessel modifications, shore infrastructure, safety, and regulatory compliance from 2030 onward.  
- Subtask 4: Build a compliance monitoring and enforcement platform that tracks GHG intensity, credit usage, and shore power connection status, and implement comprehensive QA testing (unit, integration, validation) for all calculation and connectivity logic.  

### Execution Order
- 1  
- 2  
- 3  
- 4  

### Dependencies
- Subtask 2: 1  
- Subtask 3: 1  
- Subtask 4: 1, 2, 3  

### Parallel Groups
- Group 1: 2, 3  

### Critical Path
- 1, 2, 4  

## File Structure
### Files
- **main.py** – python – FastAPI application entry point exposing REST endpoints for baseline, credit, shore power, and compliance services.  
- **config.py** – python – Central configuration loader using Pydantic BaseSettings, reading environment variables and .env files.  
- **models.py** – python – Pydantic data models for API request/response schemas and SQLAlchemy ORM models for persistence.  
- **database.py** – python – SQLAlchemy engine, session factory, and base declarative class for database interactions.  
- **baseline.py** – python – Service layer for collecting and storing 2020 baseline GHG emissions and calculating improvement milestones.  
- **credit.py** – python – Service layer implementing credit calculation logic for on‑board renewable energy generation.  
- **shore_power.py** – python – Service layer defining shore power integration specifications and compliance checks.  
- **compliance.py** – python – Service layer aggregating GHG intensity, credit usage, and shore power status into a compliance dashboard.  
- **utils.py** – python – Utility functions for unit conversions, date calculations, and common error handling.  
- **tests/test_baseline.py** – python – Unit tests for baseline data collection and milestone calculations.  
- **tests/test_credit.py** – python – Unit tests for credit framework logic.  
- **tests/test_shore_power.py** – python – Unit tests for shore power specification validation.  
- **tests/test_compliance.py** – python – Integration tests for compliance monitoring aggregation.  
- **Dockerfile** – dockerfile – Container definition for building and running the FastAPI application.  
- **requirements.txt** – txt – Python package dependencies.  
- **.env.example** – env – Template environment variables for local development.  
- **README.md** – md – Project overview, setup, and usage instructions.  
- **docs/api.md** – md – API endpoint documentation.  
- **docs/specs.md** – md – Technical specifications and regulatory compliance details.  

### Folder Structure
- root  
  - app  
    - __init__.py  
    - main.py  
    - config.py  
    - models.py  
    - database.py  
    - baseline.py  
    - credit.py  
    - shore_power.py  
    - compliance.py  
    - utils.py  
    - tests  
      - __init__.py  
      - test_baseline.py  
      - test_credit.py  
      - test_shore_power.py  
      - test_compliance.py  
  - docs  
    - api.md  
    - specs.md  
  - Dockerfile  
  - requirements.txt  
  - .env.example  
  - README.md  

### File Types
- python  
- dockerfile  
- txt  
- env  
- md  

## Technical Specifications
### main.py
- **Imports:** fastapi, uvicorn, app.config, app.models, app.baseline, app.credit, app.shore_power, app.compliance  
- **Classes:** FastAPIApp  
- **Functions:** create_app(), get_app()  
- **Data Structures:** FastAPI instance  
- **Logic Flows:**  
  1. Load configuration.  
  2. Initialize database.  
  3. Include routers from baseline, credit, shore_power, compliance.  
  4. Start Uvicorn server.  
- **Error Handling:** Return HTTP 500 on unhandled exceptions, log stack trace.  
- **Connections:** Uses config.py for settings, models.py for schemas, baseline.py/credit.py/shore_power.py/compliance.py for business logic.  

### config.py
- **Imports:** pydantic.BaseSettings, typing.Optional  
- **Classes:** Settings  
- **Functions:** get_settings()  
- **Data Structures:** Settings dataclass with DB_URL, ENV, LOG_LEVEL, etc.  
- **Logic Flows:**  
  1. Load .env file.  
  2. Populate Settings instance.  
  3. Expose get_settings() for other modules.  
- **Error Handling:** Raise ValidationError if required env vars missing.  
- **Connections:** Used by database.py, main.py, and other services.  

### models.py
- **Imports:** pydantic.BaseModel, sqlalchemy.ext.declarative.declarative_base, sqlalchemy.Column, sqlalchemy.Integer, sqlalchemy.String, sqlalchemy.Float, sqlalchemy.Date  
- **Classes:** Base, ShipType, BaselineEmission, CreditRecord, ShorePowerSpec, ComplianceRecord  
- **Functions:** to_dict()  
- **Data Structures:** SQLAlchemy ORM models for persistence, Pydantic schemas for API.  
- **Logic Flows:** Define ORM models with relationships; define Pydantic schemas mirroring ORM fields.  
- **Error Handling:** ValidationError on schema mismatch.  
- **Connections:** Used by database.py for table creation, by services for data access.  

### database.py
- **Imports:** sqlalchemy.create_engine, sqlalchemy.orm.sessionmaker, app.models.Base  
- **Classes:** Database  
- **Functions:** get_session(), init_db()  
- **Data Structures:** Engine, SessionLocal  
- **Logic Flows:**  
  1. Create engine from DB_URL.  
  2. Create sessionmaker.  
  3. Call Base.metadata.create_all(engine) to create tables.  
- **Error Handling:** Raise RuntimeError if DB connection fails.  
- **Connections:** Used by all service modules for DB access.  

### baseline.py
- **Imports:** app.database, app.models, app.utils, datetime  
- **Classes:** BaselineService  
- **Functions:** collect_baseline(ship_type:str, year:int)->BaselineEmission, calculate_milestones(), get_milestone(year:int)->float  
- **Data Structures:** BaselineEmission ORM instance, milestones dict  
- **Logic Flows:**  
  1. Query or insert baseline emission data.  
  2. Compute improvement schedule: 2 % reduction in 2025, linear to 75 % by 2050.  
  3. Store milestones.  
- **Error Handling:** Handle missing ship_type with 404; Validate year range.  
- **Connections:** Depends on database.py, models.py, utils.py.  

### credit.py
- **Imports:** app.database, app.models, app.utils  
- **Classes:** CreditService  
- **Functions:** calculate_credit(energy_generated_kwh:float, ship_id:int)->CreditRecord, apply_credit_to_intensity(ship_id:int)  
- **Data Structures:** CreditRecord ORM instance  
- **Logic Flows:**  
  1. Convert energy to CO₂ equivalent.  
  2. Create CreditRecord.  
  3. Adjust ship’s GHG intensity by credit amount.  
- **Error Handling:** Validate energy_generated_kwh > 0; Handle DB transaction errors.  
- **Connections:** Uses database.py, models.py, utils.py.  

### shore_power.py
- **Imports:** app.database, app.models, app.utils  
- **Classes:** ShorePowerService  
- **Functions:** specify_integration(vessel_type:str, shore_power_kva:int)->ShorePowerSpec, validate_connection_status(ship_id:int)->bool  
- **Data Structures:** ShorePowerSpec ORM instance  
- **Logic Flows:**  
  1. Define technical specs per vessel type.  
  2. Store specs.  
  3. Provide validation API for compliance.  
- **Error Handling:** Raise ValueError for unsupported vessel types; Handle DB errors.  
- **Connections:** Uses database.py, models.py, utils.py.  

### compliance.py
- **Imports:** app.database, app.models, app.baseline, app.credit, app.shore_power, datetime  
- **Classes:** ComplianceService  
- **Functions:** calculate_intensity(ship_id:int)->float, is_compliant(ship_id:int)->bool, generate_report(ship_id:int)->dict  
- **Data Structures:** ComplianceRecord ORM instance  
- **Logic Flows:**  
  1. Retrieve baseline and current emissions.  
  2. Apply credits.  
  3. Check shore power status.  
  4. Compare against regulatory thresholds.  
  5. Store compliance record.  
- **Error Handling:** Handle missing data with informative errors; Log compliance evaluation steps.  
- **Connections:** Depends on baseline.py, credit.py, shore_power.py, database.py, models.py.  

### utils.py
- **Imports:** datetime, pytz  
- **Classes:** None  
- **Functions:** to_utc(dt:datetime)->datetime, linear_interpolate(start_year:int,start_value:float,end_year:int,end_value:float,year:int)->float, validate_positive(value:float, name:str)  
- **Data Structures:** None  
- **Logic Flows:** Provide helper functions for date conversion, interpolation, and validation.  
- **Error Handling:** Raise ValueError for invalid inputs.  
- **Connections:** Used by baseline.py, credit.py, shore_power.py, compliance.py.  

### tests/test_baseline.py
- **Imports:** pytest, app.baseline, app.database, app.models  
- **Classes:** None  
- **Functions:** test_collect_baseline(), test_calculate_milestones()  
- **Data Structures:** None  
- **Logic Flows:** Set up test DB session; Insert sample baseline; Assert milestone calculations.  
- **Error Handling:** Use pytest fixtures for cleanup.  
- **Connections:** Depends on baseline.py, database.py, models.py.  

### tests/test_credit.py
- **Imports:** pytest, app.credit, app.database, app.models  
- **Classes:** None  
- **Functions:** test_calculate_credit(), test_apply_credit_to_intensity()  
- **Data Structures:** None  
- **Logic Flows:** Create sample ship; Calculate credit; Verify intensity adjustment.  
- **Error Handling:** Handle DB session errors.  
- **Connections:** Depends on credit.py, database.py, models.py.  

### tests/test_shore_power.py
- **Imports:** pytest, app.shore_power, app.database, app.models  
- **Classes:** None  
- **Functions:** test_specify_integration(), test_validate_connection_status()  
- **Data Structures:** None  
- **Logic Flows:** Create spec; Validate status.  
- **Error Handling:** Handle unsupported vessel types.  
- **Connections:** Depends on shore_power.py, database.py, models.py.  

### tests/test_compliance.py
- **Imports:** pytest, app.compliance, app.database, app.models  
- **Classes:** None  
- **Functions:** test_calculate_intensity(), test_is_compliant(), test_generate_report()  
- **Data Structures:** None  
- **Logic Flows:** Set up baseline, credit, shore power; Run compliance checks.  
- **Error Handling:** Handle missing data.  
- **Connections:** Depends on compliance.py, baseline.py, credit.py, shore_power.py, database.py, models.py.  

### Dockerfile
- **Imports:** None  
- **Classes:** None  
- **Functions:** None  
- **Data Structures:** None  
- **Logic Flows:**  
  ```
  FROM python:3.12-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install --no-cache-dir -r requirements.txt
  COPY . .
  CMD ["uvicorn","app.main:app","--host","0.0.0.0","--port","8000"]
  ```  
- **Error Handling:** None  
- **Connections:** Builds the FastAPI app.  

### requirements.txt
- **Imports:** None  
- **Classes:** None  
- **Functions:** None  
- **Data Structures:** None  
- **Logic Flows:**  
  ```
  fastapi
  uvicorn
  sqlalchemy
  pydantic
  pytz
  pytest
  ```  
- **Error Handling:** None  
- **Connections:** None  

## Deployment Instructions
### Setup
- 1. Clone repository.  
- 2. Create virtual environment: `python -m venv venv`.  
- 3. Activate venv: `source venv/bin/activate`.  
- 4. Install dependencies: `pip install -r requirements.txt`.  
- 5. Copy `.env.example` to `.env` and set `DB_URL`, `ENV`, `LOG_LEVEL`, etc.  

### Build
- `docker build -t fueleu-regulation .`  

### Run
- `docker run -d -p 8000:8000 --env-file .env fueleu-regulation`  

### Environment Variables
- **DB_URL:** PostgreSQL connection string, e.g., `postgres://user:pass@localhost:5432/fueleu`  
- **ENV:** `development|production`  
- **LOG_LEVEL:** `INFO`  
- **SHORE_POWER_THRESHOLD_KVA:** `5000`  

### Testing
- 1. Run unit tests: `pytest tests/`  
- 2. Run integration tests: `pytest tests/ --maxfail=1`  
- 3. Verify API endpoints with `curl` or Postman.  
- 4. Check compliance report via `GET /compliance/report/{ship_id}`.